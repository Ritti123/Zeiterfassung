<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zeiterfassung</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
      background: #f4f6f8;
    }
    h2, h3, h4 { margin-top: 0; }
    .section {
      background: #fff;
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    input::placeholder { color: #aaa; }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button.delete { background-color: #e74c3c; }
    button.secondary { background-color: #2ecc71; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #f0f0f0; }
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    .stat-box {
      flex: 1;
      min-width: 140px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background-color: white;
    }
    .settings { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="section">
    <h2>Zeiterfassung</h2>

    <div class="settings">
      <label for="work-hours">Tägliche Sollstunden:</label>
      <input type="number" id="work-hours" min="1" max="24" value="8">

      <label for="vacation-days-year">Urlaubstage pro Jahr:</label>
      <input type="number" id="vacation-days-year" min="1" max="365" value="24">
    </div>

    <div>
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    <div>
      <label for="start-time">Kommen:</label>
      <input type="time" id="start-time" placeholder="z. B. 08:00">
    </div>
    <div>
      <label for="end-time">Gehen:</label>
      <input type="time" id="end-time" placeholder="z. B. 16:30">
    </div>
    <div>
      <label for="break">Pause (Minuten):</label>
      <input type="number" id="break" value="30" placeholder="z. B. 30">
    </div>
    <div>
      <label for="type">Art:</label>
      <select id="type">
        <option value="Arbeit">Arbeit</option>
        <option value="Urlaub">Urlaub</option>
        <option value="Krank">Krank</option>
        <option value="Feiertag">Feiertag</option>
      </select>
    </div>
    <button id="add-entry-btn">Eintrag hinzufügen</button>

    <div>
      <label for="month">Monat anzeigen:</label>
      <input type="month" id="month">
    </div>

    <h3 id="report-title">Monatsreport</h3>
    <table id="time-entries">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Kommen</th>
          <th>Gehen</th>
          <th>Pause</th>
          <th>Art</th>
          <th>Stunden</th>
          <th>Soll</th>
          <th>Differenz</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="stats">
      <div class="stat-box">
        <h4>Überstunden</h4>
        <p id="overtime">0:00</p>
      </div>
      <div class="stat-box">
        <h4>Urlaubstage</h4>
        <p id="vacation-days">0 Tage</p>
      </div>
      <div class="stat-box">
        <h4>Krankheitstage</h4>
        <p id="sick-days">0 Tage</p>
      </div>
    </div>

    <button id="export-csv-btn" class="secondary">CSV exportieren</button>
    <button id="export-backup-btn" class="secondary">Backup speichern</button>
    <button id="import-backup-btn">Backup laden</button>
    <input type="file" id="import-file" style="display:none">
  </div>

  <script>
    let timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');
    let backupTimestamps = JSON.parse(localStorage.getItem('backupTimestamps') || '[]');

    const addEntryBtn = document.getElementById('add-entry-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const exportBackupBtn = document.getElementById('export-backup-btn');
    const importBackupBtn = document.getElementById('import-backup-btn');
    const importFile = document.getElementById('import-file');
    const tbody = document.querySelector('#time-entries tbody');
    const monthInput = document.getElementById('month');
    const reportTitle = document.getElementById('report-title');

    addEntryBtn.addEventListener('click', addTimeEntry);
    exportCsvBtn.addEventListener('click', exportCSV);
    exportBackupBtn.addEventListener('click', exportBackup);
    importBackupBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', handleImport);
    monthInput.addEventListener('change', loadEntries);

    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      document.getElementById('date').valueAsDate = now;
      monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('work-hours').value = localStorage.getItem('workHours') || 8;
      document.getElementById('vacation-days-year').value = localStorage.getItem('vacationDays') || 24;
      loadEntries();
      checkBackupReminder();
    });

    document.getElementById('work-hours').addEventListener('input', e => {
      localStorage.setItem('workHours', e.target.value);
    });

    document.getElementById('vacation-days-year').addEventListener('input', e => {
      localStorage.setItem('vacationDays', e.target.value);
    });

    function addTimeEntry() {
      const date = document.getElementById('date').value;
      const start = document.getElementById('start-time').value;
      const end = document.getElementById('end-time').value;
      const pause = parseInt(document.getElementById('break').value) || 0;
      const type = document.getElementById('type').value;

      if (!date || (!start && type === 'Arbeit') || (!end && type === 'Arbeit')) {
        alert('Bitte alle Pflichtfelder ausfüllen.');
        return;
      }

      let hours = '0:00';
      if (type === 'Arbeit') {
        const startDate = new Date(`${date}T${start}`);
        const endDate = new Date(`${date}T${end}`);
        const diff = (endDate - startDate) / 60000 - pause;
        if (diff <= 0) {
          alert('Endzeit muss nach Startzeit liegen.');
          return;
        }
        const h = Math.floor(diff / 60);
        const m = Math.round(diff % 60);
        hours = `${h}:${m.toString().padStart(2, '0')}`;
      }

      const existing = timeEntries.find(e => e.date === date);
      if (existing) {
        if (!confirm("Für dieses Datum existiert bereits ein Eintrag. Überschreiben?")) return;
        timeEntries = timeEntries.filter(e => e.date !== date);
      }

      timeEntries.push({ date, start, end, pause, type, hours });
      localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
      loadEntries();
      document.getElementById('start-time').value = '';
      document.getElementById('end-time').value = '';
      document.getElementById('date').valueAsDate = new Date(new Date(date).getTime() + 86400000);
    }

    function loadEntries() {
      tbody.innerHTML = '';
      let overtimeMinutes = 0;
      let vacation = 0;
      let sick = 0;

      const selectedMonth = monthInput.value;
      const [year, month] = selectedMonth.split("-");
      reportTitle.textContent = `Monatsreport ${month}.${year}`;

      const entries = timeEntries.filter(e => e.date.startsWith(selectedMonth)).sort((a, b) => new Date(a.date) - new Date(b.date));
      const workHoursPerDay = parseFloat(localStorage.getItem('workHours') || 8) * 60;

      entries.forEach(entry => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = formatDate(entry.date);
        row.insertCell(1).textContent = entry.start || '-';
        row.insertCell(2).textContent = entry.end || '-';
        row.insertCell(3).textContent = entry.pause || 0;
        row.insertCell(4).textContent = entry.type;
        row.insertCell(5).textContent = entry.hours;

        let istMin = 0;
        if (entry.type === 'Arbeit') {
          const [h, m] = entry.hours.split(":").map(Number);
          istMin = h * 60 + m;
          overtimeMinutes += istMin - workHoursPerDay;
        } else if (entry.type === 'Urlaub') vacation++;
        else if (entry.type === 'Krank') sick++;

        row.insertCell(6).textContent = entry.type === 'Arbeit' ? `${Math.floor(workHoursPerDay / 60)}:${String(workHoursPerDay % 60).padStart(2, '0')}` : '-';

        let diff = istMin - workHoursPerDay;
        row.insertCell(7).textContent = entry.type === 'Arbeit'
          ? `${diff < 0 ? '-' : ''}${Math.floor(Math.abs(diff) / 60)}:${String(Math.abs(diff) % 60).padStart(2, '0')}`
          : '-';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Löschen';
        deleteBtn.className = 'delete';
        deleteBtn.onclick = () => {
          timeEntries = timeEntries.filter(e => e !== entry);
          localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
          loadEntries();
        };
        row.insertCell(8).appendChild(deleteBtn);
      });

      const oh = Math.floor(Math.abs(overtimeMinutes) / 60);
      const om = Math.abs(overtimeMinutes) % 60;
      const sign = overtimeMinutes < 0 ? "-" : "";
      document.getElementById('overtime').textContent = `${sign}${oh}:${String(om).padStart(2, '0')}`;
      document.getElementById('vacation-days').textContent = `${vacation} Tage`;
      document.getElementById('sick-days').textContent = `${sick} Tage`;
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}.${m}.${y}`;
    }

    function exportCSV() {
      const selectedMonth = monthInput.value;
      const [year, month] = selectedMonth.split("-");
      const entries = timeEntries.filter(e => e.date.startsWith(selectedMonth));
      if (entries.length === 0) return alert('Keine Daten vorhanden.');

      let csv = `Monatsreport ${month}.${year}\nDatum;Kommen;Gehen;Pause;Art;Stunden\n`;
      entries.forEach(e => {
        csv += `${formatDate(e.date)};${e.start || ''};${e.end || ''};${e.pause};${e.type};${e.hours}\n`;
      });

      const overtime = document.getElementById('overtime').textContent;
      const vacation = document.getElementById('vacation-days').textContent;
      const sick = document.getElementById('sick-days').textContent;
      csv += `\nÜberstunden:;${overtime}\nUrlaubstage:;${vacation}\nKrankheitstage:;${sick}\n`;

      download(`Monatsreport ${month}.${year}.csv`, csv, 'text/csv');
    }

    function exportBackup() {
      const data = { entries: timeEntries, exported: new Date().toISOString() };
      const now = new Date().getTime();
      backupTimestamps.push(now);
      while (backupTimestamps.length > 2) backupTimestamps.shift();
      localStorage.setItem('backupTimestamps', JSON.stringify(backupTimestamps));
      download(`backup_zeiterfassung_${now}.json`, JSON.stringify(data, null, 2), 'application/json');
    }

    function download(filename, content, type) {
      const blob = new Blob(["\uFEFF" + content], { type });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const data = JSON.parse(event.target.result);
          if (!Array.isArray(data.entries)) throw new Error('Ungültiges Format');
          if (confirm(`${data.entries.length} Einträge importieren? Vorherige Daten werden überschrieben.`)) {
            timeEntries = data.entries;
            localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
            loadEntries();
            alert('Import erfolgreich.');
          }
        } catch (err) {
          alert('Fehler beim Import: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function checkBackupReminder() {
      const last = backupTimestamps[backupTimestamps.length - 1] || 0;
      const now = new Date().getTime();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      if (now - last > oneWeek) {
        alert("Es ist über eine Woche seit dem letzten Backup vergangen. Bitte speichern Sie ein neues Backup.");
      }
    }
  </script>
</body>
</html>
      





