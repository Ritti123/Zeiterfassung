

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Zeiterfassung</title>
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --danger-color: #ea4335;
      --text-color: #333;
      --border-color: #ddd;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      padding: 10px; 
      max-width: 600px; 
      margin: auto; 
      color: var(--text-color);
      line-height: 1.5;
    }
    
    h2, h3 {
      color: var(--primary-color);
      margin-top: 0;
    }
    
    input, select, button { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0; 
      font-size: 16px; 
      box-sizing: border-box; 
      border: 1px solid var(--border-color);
      border-radius: 8px;
      -webkit-appearance: none;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button.danger {
      background-color: var(--danger-color);
    }
    
    button.secondary {
      background-color: var(--secondary-color);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      font-size: 14px;
    }
    
    th, td { 
      border: 1px solid var(--border-color); 
      padding: 8px; 
      text-align: center; 
    }
    
    thead { 
      background: #f5f5f5; 
      font-weight: bold;
    }
    
    tfoot { 
      background: #f8f8f8; 
      font-weight: bold; 
    }
    
    .small-btn { 
      padding: 6px 10px; 
      font-size: 12px; 
      border-radius: 4px;
    }
    
    #month-nav { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 15px 0; 
      gap: 10px; 
    }
    
    #current-month { 
      flex: 1; 
      text-align: center; 
      font-weight: bold; 
      font-size: 18px;
    }
    
    #user-section { 
      border: 1px solid var(--border-color); 
      padding: 15px; 
      margin-bottom: 20px; 
      border-radius: 10px;
    }
    
    .reset-pin { 
      display: flex; 
      gap: 8px; 
      margin-top: 10px; 
      align-items: center; 
    }
    
    .reset-pin input { 
      flex: 1; 
    }
    
    .backup-section { 
      margin-top: 25px; 
      border-top: 1px solid var(--border-color); 
      padding-top: 15px; 
    }
    
    .backup-buttons { 
      display: flex; 
      flex-direction: column;
      gap: 10px; 
      margin-top: 15px; 
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      input, select, button {
        padding: 10px;
        font-size: 14px;
      }
      
      table {
        font-size: 12px;
      }
    }
    
    /* iPhone Optimierungen */
    @supports (-webkit-touch-callout: none) {
      input, select, button {
        min-height: 44px; /* Apple empfiehlt mindestens 44px fÃ¼r tappbare Elemente */
      }
      
      select {
        padding: 12px 15px;
      }
    }
  </style>
</head>
<body>

<div id="user-section">
  <h2>Benutzerverwaltung</h2>
  <div id="user-login">
    <div class="form-group">
      <label for="user-select">Benutzer auswÃ¤hlen:</label>
      <select id="user-select"></select>
    </div>
    <div class="form-group">
      <label for="user-pin">PIN eingeben:</label>
      <input type="password" id="user-pin" placeholder="4-stelliger PIN" maxlength="4" inputmode="numeric" />
    </div>
    <button onclick="login()">Anmelden</button>
  </div>
  
  <h3 style="margin-top: 20px;">Benutzer erstellen/lÃ¶schen</h3>
  <div id="user-manage">
    <div class="form-group">
      <label for="new-user-name">Neuer Benutzername:</label>
      <input type="text" id="new-user-name" placeholder="Name eingeben" />
    </div>
    <div class="form-group">
      <label for="new-user-pin">Neue PIN (4-stellig):</label>
      <input type="password" id="new-user-pin" placeholder="PIN eingeben" maxlength="4" inputmode="numeric" />
    </div>
    <button onclick="createUser()">Benutzer anlegen</button>
    <button class="danger" onclick="deleteUser()">Benutzer lÃ¶schen</button>
    <div id="reset-area" style="margin-top: 15px;"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div id="month-nav">
    <button onclick="changeMonth(-1)">â€¹ Vorheriger Monat</button>
    <div id="current-month"></div>
    <button onclick="changeMonth(1)">NÃ¤chster Monat â€º</button>
  </div>

  <h2>Neuer Zeiteintrag</h2>
  <form onsubmit="addEntry(); return false;">
    <div class="form-group">
      <label for="datum">Datum:</label>
      <input type="date" id="datum" required pattern="\d{2}\.\d{2}\.\d{4}" />
    </div>
    <div class="form-group">
      <label for="startzeit">Startzeit:</label>
      <input type="time" id="startzeit" required />
    </div>
    <div class="form-group">
      <label for="endzeit">Endzeit:</label>
      <input type="time" id="endzeit" required />
    </div>
    <div class="form-group">
      <label for="pause">Pausenzeit (Minuten):</label>
      <input type="number" id="pause" placeholder="Pause in Minuten" required value="60" min="0" step="15" />
    </div>
    <div class="form-group">
      <label for="typ">Art des Eintrags:</label>
      <select id="typ">
        <option value="Arbeit">Arbeit</option>
        <option value="Urlaub">Urlaub</option>
        <option value="Krank">Krankheit</option>
        <option value="Feiertag">Feiertag</option>
      </select>
    </div>
    <button type="submit">Zeiteintrag speichern</button>
  </form>

  <h2>Zeiterfassung</h2>
  <table id="tabelle">
    <thead>
      <tr>
        <th>Datum</th>
        <th>Start</th>
        <th>Ende</th>
        <th>Pause</th>
        <th>Art</th>
        <th>Arbeitszeit</th>
        <th>Soll</th>
        <th>Differenz</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="9" id="summen"></td>
      </tr>
    </tfoot>
  </table>
  
  <div class="backup-section">
    <h3>Daten-Sicherung</h3>
    <p>Sichern Sie regelmÃ¤ÃŸig Ihre Daten zur Sicherheit.</p>
    <div class="backup-buttons">
      <button class="secondary" onclick="exportCSV()">ðŸ“Š Als Excel exportieren</button>
      <button class="secondary" onclick="backupData()">ðŸ’¾ Komplette Sicherung erstellen</button>
      <button class="secondary" onclick="document.getElementById('restore-file').click()">ðŸ”„ Sicherung wiederherstellen</button>
      <input type="file" id="restore-file" accept=".json" style="display:none" onchange="restoreData(this.files[0])"/>
    </div>
  </div>
  
  <button style="margin-top: 30px;" class="danger" onclick="logout()">ðŸ”’ Abmelden</button>
</div>

<script>
let eintraege = JSON.parse(localStorage.getItem('eintraege') || '[]');
let users = JSON.parse(localStorage.getItem('users') || '[]');
let currentUser = null;
let urlaubstage = 24;
let sollStunden = 8; // 8 Stunden = 480 Minuten
let viewDate = new Date();

// Backup-Erinnerung
function checkBackupReminder() {
  const lastBackup = localStorage.getItem('lastBackup');
  if (!lastBackup || (new Date() - new Date(lastBackup)) > 30*24*60*60*1000) {
    if (confirm("Es wurde seit Ã¼ber 30 Tagen kein Backup erstellt.\nMÃ¶chten Sie jetzt eine Sicherung erstellen?")) {
      backupData();
    }
  }
}

// Formatierung Minuten in Stunden und Minuten
function formatMinutes(totalMinutes) {
  if (isNaN(totalMinutes)) return "0 Min";
  const hours = Math.floor(Math.abs(totalMinutes) / 60);
  const minutes = Math.abs(totalMinutes) % 60;
  const sign = totalMinutes < 0 ? "-" : "";
  
  if (hours > 0 && minutes > 0) {
    return `${sign}${hours} Std ${minutes} Min`;
  } else if (hours > 0) {
    return `${sign}${hours} Std`;
  } else {
    return `${sign}${minutes} Min`;
  }
}

function save() {
  localStorage.setItem('eintraege', JSON.stringify(eintraege));
  renderTabelle();
}

function saveUsers() {
  localStorage.setItem('users', JSON.stringify(users));
  renderUserSelect();
  renderResetList();
}

function login() {
  const name = document.getElementById('user-select').value;
  const pin = document.getElementById('user-pin').value.trim();
  const user = users.find(u => u.name === name && u.pin === pin);
  if (user) {
    currentUser = user.name;
    document.getElementById('app').style.display = 'block';
    document.getElementById('user-section').style.display = 'none';
    renderTabelle();
    checkBackupReminder();
    document.getElementById('user-pin').value = '';
  } else {
    alert("Falscher PIN oder Benutzer");
  }
}

function logout() {
  if (confirm("MÃ¶chten Sie sich wirklich abmelden?")) {
    currentUser = null;
    document.getElementById('app').style.display = 'none';
    document.getElementById('user-section').style.display = 'block';
  }
}

function createUser() {
  const name = document.getElementById('new-user-name').value.trim();
  const pin = document.getElementById('new-user-pin').value.trim();
  
  if (!name) return alert("Bitte geben Sie einen Namen ein");
  if (pin.length !== 4 || !/^\d+$/.test(pin)) return alert("Bitte geben Sie einen 4-stelligen Zahlen-PIN ein");
  
  if (users.some(u => u.name === name)) {
    return alert("Benutzername existiert bereits");
  }
  
  users.push({ name, pin });
  saveUsers();
  document.getElementById('new-user-name').value = '';
  document.getElementById('new-user-pin').value = '';
  alert(`Benutzer "${name}" wurde erfolgreich angelegt`);
}

function deleteUser() {
  const name = document.getElementById('user-select').value;
  if (!name) return alert("Kein Benutzer ausgewÃ¤hlt");
  
  if (confirm(`MÃ¶chten Sie den Benutzer "${name}" wirklich lÃ¶schen?\n\nAlle zugehÃ¶rigen ZeiteintrÃ¤ge werden ebenfalls entfernt!`)) {
    users = users.filter(u => u.name !== name);
    eintraege = eintraege.filter(e => e.user !== name);
    saveUsers();
    save();
    alert(`Benutzer "${name}" wurde gelÃ¶scht.`);
  }
}

function renderUserSelect() {
  const select = document.getElementById('user-select');
  select.innerHTML = users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
}

function renderResetList() {
  const container = document.getElementById('reset-area');
  container.innerHTML = '';
  if (currentUser) return;
  
  if (users.length === 0) {
    container.innerHTML = '<p>Keine Benutzer vorhanden</p>';
    return;
  }
  
  container.innerHTML = '<h4>PIN zurÃ¼cksetzen</h4>';
  
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = 'reset-pin';
    div.innerHTML = `
      <label style="flex:1;">${user.name}</label>
      <input type="password" maxlength="4" placeholder="neuer PIN" id="newpin-${user.name}" inputmode="numeric" />
      <button class="small-btn" onclick="resetPin('${user.name}')">PIN Ã¤ndern</button>
    `;
    container.appendChild(div);
  });
}

function resetPin(name) {
  const input = document.getElementById(`newpin-${name}`);
  const pin = input.value.trim();
  
  if (pin.length !== 4 || !/^\d+$/.test(pin)) {
    return alert("Bitte einen 4-stelligen Zahlen-PIN eingeben.");
  }
  
  const user = users.find(u => u.name === name);
  if (user) {
    user.pin = pin;
    saveUsers();
    alert(`PIN fÃ¼r ${name} wurde geÃ¤ndert`);
    input.value = '';
  }
}

function formatDate(d) {
  const [year, month, day] = d.split("-");
  return `${day}.${month}.${year}`;
}

function parseMinutes(t) {
  if (!t) return 0;
  const [h, m] = t.split(":").map(Number);
  return h * 60 + (m || 0);
}

function addEntry() {
  const datum = document.getElementById('datum').value;
  const start = document.getElementById('startzeit').value;
  const end = document.getElementById('endzeit').value;
  const pause = parseInt(document.getElementById('pause').value) || 0;
  const typ = document.getElementById('typ').value;
  
  if (!datum || !start || !end) {
    return alert("Bitte fÃ¼llen Sie alle Felder aus");
  }
  
  if (parseMinutes(end) <= parseMinutes(start)) {
    return alert("Endzeit muss nach der Startzeit liegen");
  }
  
  eintraege.push({ 
    user: currentUser, 
    datum, 
    start, 
    end, 
    pause, 
    typ 
  });
  
  save();
  
  // Formular zurÃ¼cksetzen
  document.getElementById('datum').value = '';
  document.getElementById('startzeit').value = '';
  document.getElementById('endzeit').value = '';
  document.getElementById('pause').value = '60';
  
  // Zum Tabellenanfang scrollen fÃ¼r mobile GerÃ¤te
  document.querySelector('table')?.scrollIntoView({ behavior: 'smooth' });
}

function renderTabelle() {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  const monat = viewDate.toISOString().slice(0,7);
  
  let arbeitsMinuten = 0;
  let sollMinuten = 0;
  let urlaub = 0;
  let krank = 0;
  
  const monatsEintraege = eintraege
    .filter(e => e.user === currentUser && e.datum.startsWith(monat))
    .sort((a, b) => new Date(a.datum) - new Date(b.datum)));
  
  monatsEintraege.forEach((e, i) => {
    const startMinuten = parseMinutes(e.start);
    const endMinuten = parseMinutes(e.end);
    const istMinuten = Math.max(0, endMinuten - startMinuten - (e.pause || 0));
    
    if (e.typ === "Arbeit") {
      arbeitsMinuten += istMinuten;
      sollMinuten += sollStunden * 60;
    } else if (e.typ === "Urlaub") {
      urlaub++;
    } else if (e.typ === "Krank") {
      krank++;
    }
    
    const diffMinuten = e.typ === "Arbeit" ? istMinuten - (sollStunden * 60) : 0;
    
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${formatDate(e.datum)}</td>
      <td>${e.start}</td>
      <td>${e.end}</td>
      <td>${e.pause} Min</td>
      <td>${e.typ}</td>
      <td>${e.typ === "Arbeit" ? formatMinutes(istMinuten) : ""}</td>
      <td>${e.typ === "Arbeit" ? formatMinutes(sollStunden * 60) : ""}</td>
      <td>${e.typ === "Arbeit" ? formatMinutes(diffMinuten) : ""}</td>
      <td><button class="small-btn danger" onclick="deleteEntry(${monatsEintraege.length - 1 - i})">âœ•</button></td>
    `;
    tbody.appendChild(tr);
  });
  
  const diffGesamt = arbeitsMinuten - sollMinuten;
  
  document.getElementById("summen").innerHTML = `
    <strong>Zusammenfassung:</strong><br>
    Arbeitszeit: ${formatMinutes(arbeitsMinuten)}<br>
    Soll-Zeit: ${formatMinutes(sollMinuten)}<br>
    Saldo: ${formatMinutes(diffGesamt)}<br>
    Urlaubstage: ${urlaub}/${urlaubstage}<br>
    Krankheitstage: ${krank}
  `;
  
  const monthNames = ["Januar", "Februar", "MÃ¤rz", "April", "Mai", "Juni", 
                     "Juli", "August", "September", "Oktober", "November", "Dezember"];
  document.getElementById("current-month").textContent = 
    `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
}

function deleteEntry(index) {
  if (confirm("Diesen Eintrag wirklich lÃ¶schen?")) {
    // Finde den tatsÃ¤chlichen Index im Gesamtarray
    const monat = viewDate.toISOString().slice(0,7);
    const monatsEintraege = eintraege
      .filter(e => e.user === currentUser && e.datum.startsWith(monat));
    
    if (index >= 0 && index < monatsEintraege.length) {
      const eintrag = monatsEintraege[index];
      const globalIndex = eintraege.findIndex(e => 
        e.user === currentUser && 
        e.datum === eintrag.datum && 
        e.start === eintrag.start && 
        e.end === eintrag.end);
      
      if (globalIndex !== -1) {
        eintraege.splice(globalIndex, 1);
        save();
      }
    }
  }
}

function changeMonth(dir) {
  viewDate.setMonth(viewDate.getMonth() + dir);
  renderTabelle();
}

function exportCSV() {
  const headers = ["Datum","Start","Ende","Pause (Min)","Art","Arbeitszeit","Soll","Differenz"];
  const rows = [headers];
  
  eintraege
    .filter(e => e.user === currentUser)
    .sort((a, b) => new Date(a.datum) - new Date(b.datum)))
    .forEach(e => {
      const startMinuten = parseMinutes(e.start);
      const endMinuten = parseMinutes(e.end);
      const istMinuten = Math.max(0, endMinuten - startMinuten - (e.pause || 0));
      
      rows.push([
        formatDate(e.datum), 
        e.start, 
        e.end, 
        e.pause,
        e.typ,
        e.typ === "Arbeit" ? formatMinutes(istMinuten) : "",
        e.typ === "Arbeit" ? formatMinutes(sollStunden * 60) : "",
        e.typ === "Arbeit" ? formatMinutes(istMinuten - (sollStunden * 60)) : ""
      ]);
    });
  
  const csvContent = rows.map(row => 
    row.map(field => `"${field.replace(/"/g, '""')}"`).join(';')
  ).join('\n');
  
  const blob = new Blob(["\uFEFF" + csvContent], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `zeiterfassung_${currentUser}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function backupData() {
  const data = {
    users: users,
    eintraege: eintraege,
    meta: {
      timestamp: new Date().toISOString(),
      version: "1.0",
      createdBy: "Zeiterfassungssystem"
    }
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `zeiterfassung_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  localStorage.setItem('lastBackup', new Date().toISOString());
  alert("Sicherung wurde erstellt und heruntergeladen");
}

function restoreData(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    if (confirm("Sicher, dass Sie diese Sicherung wiederherstellen mÃ¶chten?\nAlle aktuellen Daten werden Ã¼berschrieben!")) {
      try {
        const data = JSON.parse(e.target.result);
        
        if (!data.users || !data.eintraege) {
          throw new Error("UngÃ¼ltiges Backup-Format: Benutzer oder EintrÃ¤ge fehlen");
        }
        
        // BestÃ¤tigung fÃ¼r jeden Benutzer, der Ã¼berschrieben wird
        const existingUsers = users.map(u => u.name);
        const overwrittenUsers = data.users.filter(u => existingUsers.includes(u.name));
        
        if (overwrittenUsers.length > 0) {
          if (!confirm(`Folgende Benutzer werden Ã¼berschrieben:\n${overwrittenUsers.map(u => u.name).join(', ')}\nFortfahren?`)) {
            return;
          }
        }
        
        users = data.users;
        eintraege = data.eintraege;
        saveUsers();
        save();
        
        alert(`Daten erfolgreich wiederhergestellt!\n${data.users.length} Benutzer\n${data.eintraege.length} ZeiteintrÃ¤ge`);
        
        if (currentUser) {
          renderTabelle();
        }
      } catch (error) {
        alert("Fehler beim Wiederherstellen:\n" + error.message);
      }
    }
  };
  
  reader.onerror = function() {
    alert("Fehler beim Lesen der Datei");
  };
  
  reader.readAsText(file);
}

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
  renderUserSelect();
  renderResetList();
  
  // Heutiges Datum als Standard setzen
  const today = new Date();
  document.getElementById('datum').valueAsDate = today;
  
  // FÃ¼r mobile GerÃ¤te: Datumseingabe optimieren
  if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    document.getElementById('datum').addEventListener('focus', function() {
      this.blur(); // Standard-Picker schlieÃŸen
      // Alternativen Picker anzeigen oder andere LÃ¶sung
    });
  }
});
</script>
</body>
</html>
