<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zeiterfassung</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button.delete {
      background-color: #f44336;
    }
    input, select {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .container {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Zeiterfassung</h1>
    
    <div>
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    
    <div>
      <label for="start">Startzeit:</label>
      <input type="time" id="start">
    </div>
    
    <div>
      <label for="end">Endzeit:</label>
      <input type="time" id="end">
    </div>
    
    <div>
      <label for="pause">Pause (Minuten):</label>
      <input type="number" id="pause" value="30">
    </div>
    
    <button id="add-entry">Eintrag hinzufügen</button>
    
    <div>
      <label for="month-select">Monat anzeigen:</label>
      <input type="month" id="month-select">
    </div>
    
    <table id="entries-table">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Start</th>
          <th>Ende</th>
          <th>Pause</th>
          <th>Stunden</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <button id="export-pdf">PDF Export</button>
    <button id="export-backup">Backup erstellen</button>
  </div>

  <script>
    // PDF Library initialisieren
    const { jsPDF } = window.jspdf;
    
    // Datenbank
    let entries = JSON.parse(localStorage.getItem('timeEntries') || [];
    
    // DOM Elemente
    const dateInput = document.getElementById('date');
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const pauseInput = document.getElementById('pause');
    const addEntryBtn = document.getElementById('add-entry');
    const monthSelect = document.getElementById('month-select');
    const entriesTable = document.getElementById('entries-table');
    const exportPdfBtn = document.getElementById('export-pdf');
    const exportBackupBtn = document.getElementById('export-backup');
    
    // Initialisierung
    function init() {
      const today = new Date();
      dateInput.valueAsDate = today;
      monthSelect.value = today.toISOString().slice(0, 7);
      loadEntries();
    }
    
    // Eintrag hinzufügen
    addEntryBtn.addEventListener('click', () => {
      const date = dateInput.value;
      const start = startInput.value;
      const end = endInput.value;
      const pause = parseInt(pauseInput.value) || 0;
      
      if (!date || !start || !end) {
        alert('Bitte alle Felder ausfüllen');
        return;
      }
      
      // Stunden berechnen
      const startTime = new Date(`${date}T${start}`);
      const endTime = new Date(`${date}T${end}`);
      const diffMs = endTime - startTime;
      const diffMins = (diffMs / (1000 * 60)) - pause;
      
      if (diffMins < 0) {
        alert('Endzeit muss nach Startzeit liegen');
        return;
      }
      
      const hours = Math.floor(diffMins / 60);
      const mins = Math.round(diffMins % 60);
      const hoursFormatted = `${hours}:${mins.toString().padStart(2, '0')}`;
      
      // Eintrag speichern
      entries.push({
        date,
        start,
        end,
        pause,
        hours: hoursFormatted
      });
      
      saveData();
      loadEntries();
      
      // Formular zurücksetzen
      startInput.value = '';
      endInput.value = '';
      pauseInput.value = '30';
    });
    
    // Monat ändern
    monthSelect.addEventListener('change', loadEntries);
    
    // PDF Export
    exportPdfBtn.addEventListener('click', exportToPDF);
    
    // Backup Export
    exportBackupBtn.addEventListener('click', createBackup);
    
    // Daten laden
    function loadEntries() {
      const month = monthSelect.value;
      const filtered = entries.filter(entry => entry.date.startsWith(month));
      
      let tableHTML = '';
      filtered.forEach(entry => {
        tableHTML += `
          <tr>
            <td>${formatDate(entry.date)}</td>
            <td>${entry.start}</td>
            <td>${entry.end}</td>
            <td>${entry.pause} min</td>
            <td>${entry.hours}</td>
            <td><button class="delete" onclick="deleteEntry('${entry.date}','${entry.start}','${entry.end}')">Löschen</button></td>
          </tr>
        `;
      });
      
      entriesTable.querySelector('tbody').innerHTML = tableHTML || '<tr><td colspan="6">Keine Einträge</td></tr>';
    }
    
    // Eintrag löschen
    window.deleteEntry = function(date, start, end) {
      entries = entries.filter(entry => 
        !(entry.date === date && entry.start === start && entry.end === end)
      );
      saveData();
      loadEntries();
    };
    
    // PDF Export
    function exportToPDF() {
      const month = monthSelect.value;
      const [year, monthNum] = month.split('-');
      const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                         'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const monthName = monthNames[parseInt(monthNum) - 1];
      
      const filtered = entries.filter(entry => entry.date.startsWith(month));
      
      if (filtered.length === 0) {
        alert('Keine Einträge für diesen Monat vorhanden');
        return;
      }
      
      const doc = new jsPDF();
      
      // Titel
      doc.setFontSize(18);
      doc.text(`Monatsreport ${monthName} ${year}`, 105, 15, { align: 'center' });
      
      // Tabelle
      const headers = [['Datum', 'Start', 'Ende', 'Pause', 'Stunden']];
      const data = filtered.map(entry => [
        formatDate(entry.date),
        entry.start,
        entry.end,
        `${entry.pause} min`,
        entry.hours
      ]);
      
      doc.autoTable({
        head: headers,
        body: data,
        startY: 25,
        margin: { horizontal: 10 },
        styles: { 
          fontSize: 9,
          cellPadding: 3,
          overflow: 'linebreak'
        },
        headStyles: {
          fillColor: [76, 175, 80],
          textColor: 255
        }
      });
      
      // Gesamtstunden berechnen
      const totalHours = filtered.reduce((sum, entry) => {
        const [h, m] = entry.hours.split(':').map(Number);
        return sum + h + (m / 60);
      }, 0);
      
      const totalHoursFormatted = `${Math.floor(totalHours)}:${Math.round((totalHours % 1) * 60).toString().padStart(2, '0')}`;
      
      // Footer mit Gesamtstunden
      doc.setFontSize(12);
      doc.text(`Gesamtstunden: ${totalHoursFormatted}`, 14, doc.lastAutoTable.finalY + 10);
      
      // Speichern
      doc.save(`Zeiterfassung_${monthName}_${year}.pdf`);
    }
    
    // Backup erstellen
    function createBackup() {
      const backupData = {
        entries,
        exported: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `zeiterfassung_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }
    
    // Hilfsfunktionen
    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}.${m}.${y}`;
    }
    
    function saveData() {
      localStorage.setItem('timeEntries', JSON.stringify(entries));
    }
    
    // Initialisierung
    init();
  </script>
</body>
</html>