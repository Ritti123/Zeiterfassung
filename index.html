<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Zeiterfassung</title>
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --danger-color: #ea4335;
      --text-color: #333;
      --border-color: #ddd;
      --background-color: #f9f9f9;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      padding: 10px; 
      max-width: 600px; 
      margin: auto; 
      color: var(--text-color);
      line-height: 1.5;
      background-color: var(--background-color);
    }
    
    h2, h3 {
      color: var(--primary-color);
      margin-top: 0;
    }
    
    input, select, button { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0; 
      font-size: 16px; 
      box-sizing: border-box; 
      border: 1px solid var(--border-color);
      border-radius: 8px;
      -webkit-appearance: none;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button.danger {
      background-color: var(--danger-color);
    }
    
    button.secondary {
      background-color: var(--secondary-color);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      font-size: 14px;
      background: white;
    }
    
    th, td { 
      border: 1px solid var(--border-color); 
      padding: 10px; 
      text-align: center; 
    }
    
    thead { 
      background: #f5f5f5; 
      font-weight: bold;
    }
    
    tfoot { 
      background: #f8f8f8; 
      font-weight: bold; 
    }
    
    .small-btn { 
      padding: 6px 10px; 
      font-size: 12px; 
      border-radius: 4px;
    }
    
    #month-nav { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 15px 0; 
      gap: 10px; 
    }
    
    #current-month { 
      flex: 1; 
      text-align: center; 
      font-weight: bold; 
      font-size: 18px;
    }
    
    #user-section { 
      border: 1px solid var(--border-color); 
      padding: 15px; 
      margin-bottom: 20px; 
      border-radius: 10px;
      background: white;
    }
    
    .reset-pin { 
      display: flex; 
      gap: 8px; 
      margin-top: 10px; 
      align-items: center; 
    }
    
    .reset-pin input { 
      flex: 1; 
    }
    
    .backup-section { 
      margin-top: 25px; 
      border-top: 1px solid var(--border-color); 
      padding-top: 15px; 
    }
    
    .backup-buttons { 
      display: flex; 
      flex-direction: column;
      gap: 10px; 
      margin-top: 15px; 
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    /* iPhone Optimierungen */
    @supports (-webkit-touch-callout: none) {
      input, select, button {
        min-height: 44px;
      }
      
      select {
        padding: 12px 15px;
      }
      
      .small-btn {
        min-height: 30px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      input, select, button {
        padding: 10px;
        font-size: 14px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 6px;
      }
    }
  </style>
</head>
<body>

<div id="user-section">
  <h2>Benutzerverwaltung</h2>
  <div id="user-login">
    <div class="form-group">
      <label for="user-select">Benutzer auswählen:</label>
      <select id="user-select">
        <option value="">-- Bitte auswählen --</option>
      </select>
    </div>
    <div class="form-group">
      <label for="user-pin">PIN eingeben:</label>
      <input type="password" id="user-pin" placeholder="4-stelliger PIN" maxlength="4" inputmode="numeric" />
    </div>
    <button onclick="login()">Anmelden</button>
  </div>
  
  <h3 style="margin-top: 20px;">Benutzer erstellen/löschen</h3>
  <div id="user-manage">
    <div class="form-group">
      <label for="new-user-name">Neuer Benutzername:</label>
      <input type="text" id="new-user-name" placeholder="Name eingeben" />
    </div>
    <div class="form-group">
      <label for="new-user-pin">Neue PIN (4-stellig):</label>
      <input type="password" id="new-user-pin" placeholder="PIN eingeben" maxlength="4" inputmode="numeric" />
    </div>
    <button onclick="createUser()">Benutzer anlegen</button>
    <button class="danger" onclick="deleteUser()">Benutzer löschen</button>
    <div id="reset-area" style="margin-top: 15px;"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div id="month-nav">
    <button onclick="changeMonth(-1)">‹</button>
    <div id="current-month"></div>
    <button onclick="changeMonth(1)">›</button>
  </div>

  <form onsubmit="addEntry(); return false;">
    <div class="form-group">
      <label for="datum">Datum:</label>
      <input type="date" id="datum" required />
    </div>
    <div class="form-group">
      <label for="startzeit">Startzeit:</label>
      <input type="time" id="startzeit" required />
    </div>
    <div class="form-group">
      <label for="endzeit">Endzeit:</label>
      <input type="time" id="endzeit" required />
    </div>
    <div class="form-group">
      <label for="pause">Pause (Minuten):</label>
      <input type="number" id="pause" placeholder="Pause in Minuten" required value="60" />
    </div>
    <div class="form-group">
      <label for="typ">Art:</label>
      <select id="typ">
        <option value="Arbeit">Arbeit</option>
        <option value="Urlaub">Urlaub</option>
        <option value="Krank">Krank</option>
        <option value="Feiertag">Feiertag</option>
      </select>
    </div>
    <button type="submit">Eintragen</button>
  </form>

  <table id="tabelle">
    <thead>
      <tr>
        <th>Datum</th>
        <th>Kommen</th>
        <th>Gehen</th>
        <th>Pause</th>
        <th>Typ</th>
        <th>Ist</th>
        <th>Soll</th>
        <th>+/-</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="8" id="summen"></td>
      </tr>
    </tfoot>
  </table>
  
  <div class="backup-section">
    <h3>Daten-Sicherung</h3>
    <div class="backup-buttons">
      <button class="secondary" onclick="exportCSV()">Excel Export</button>
      <button class="secondary" onclick="backupData()">Komplette Sicherung erstellen</button>
      <button onclick="document.getElementById('restore-file').click()">Sicherung wiederherstellen</button>
      <input type="file" id="restore-file" accept=".json" style="display:none" onchange="restoreData(this.files[0])"/>
    </div>
  </div>
</div>

<script>
let eintraege = JSON.parse(localStorage.getItem('eintraege') || [];
let users = JSON.parse(localStorage.getItem('users') || '[]');
let currentUser = null;
let urlaubstage = 24;
let sollStunden = 8;
let viewDate = new Date();

// Initialisierung beim Laden
document.addEventListener('DOMContentLoaded', function() {
  renderUserSelect();
  renderResetList();
  
  // Heutiges Datum als Standard setzen
  const today = new Date();
  document.getElementById('datum').valueAsDate = today;
  
  // Backup-Erinnerung
  const lastBackup = localStorage.getItem('lastBackup');
  if (!lastBackup || (new Date() - new Date(lastBackup)) > 30*24*60*60*1000) {
    setTimeout(() => {
      if (confirm("Es wurde seit über 30 Tagen kein Backup erstellt.\nMöchten Sie jetzt eine Sicherung erstellen?")) {
        backupData();
        localStorage.setItem('lastBackup', new Date().toISOString());
      }
    }, 1000);
  }
});

function save() {
  localStorage.setItem('eintraege', JSON.stringify(eintraege));
  renderTabelle();
}

function saveUsers() {
  localStorage.setItem('users', JSON.stringify(users));
  renderUserSelect();
  renderResetList();
}

function login() {
  const name = document.getElementById('user-select').value;
  const pin = document.getElementById('user-pin').value.trim();
  
  if (!name) {
    alert("Bitte einen Benutzer auswählen");
    return;
  }
  
  if (pin.length !== 4 || !/^\d+$/.test(pin)) {
    alert("Bitte einen 4-stelligen Zahlen-PIN eingeben");
    return;
  }
  
  const user = users.find(u => u.name === name);
  
  if (!user) {
    alert("Benutzer nicht gefunden");
    return;
  }
  
  if (user.pin !== pin) {
    alert("Falscher PIN");
    return;
  }
  
  currentUser = user.name;
  document.getElementById('app').style.display = 'block';
  document.getElementById('user-section').style.display = 'none';
  document.getElementById('user-pin').value = '';
  renderTabelle();
}

function logout() {
  currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('user-section').style.display = 'block';
}

function createUser() {
  const name = document.getElementById('new-user-name').value.trim();
  const pin = document.getElementById('new-user-pin').value.trim();
  
  if (!name) {
    alert("Bitte geben Sie einen Namen ein");
    return;
  }
  
  if (pin.length !== 4 || !/^\d+$/.test(pin)) {
    alert("Bitte einen 4-stelligen Zahlen-PIN eingeben");
    return;
  }
  
  if (users.some(u => u.name.toLowerCase() === name.toLowerCase())) {
    alert("Benutzername existiert bereits");
    return;
  }
  
  const newUser = { name, pin };
  users.push(newUser);
  saveUsers();
  
  // Formular leeren und Select aktualisieren
  document.getElementById('new-user-name').value = '';
  document.getElementById('new-user-pin').value = '';
  
  // Neuen Benutzer selektieren
  document.getElementById('user-select').value = name;
  
  alert(`Benutzer "${name}" wurde erfolgreich angelegt`);
}

function deleteUser() {
  const name = document.getElementById('user-select').value;
  
  if (!name) {
    alert("Bitte wählen Sie einen Benutzer aus");
    return;
  }
  
  if (confirm(`Möchten Sie den Benutzer "${name}" wirklich löschen?\n\nAlle zugehörigen Zeiteinträge werden ebenfalls entfernt!`)) {
    users = users.filter(u => u.name !== name);
    eintraege = eintraege.filter(e => e.user !== name);
    saveUsers();
    save();
    alert(`Benutzer "${name}" wurde gelöscht.`);
  }
}

function renderUserSelect() {
  const select = document.getElementById('user-select');
  select.innerHTML = '<option value="">-- Bitte auswählen --</option>' + 
    users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
}

function renderResetList() {
  const container = document.getElementById('reset-area');
  container.innerHTML = '';
  
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = 'reset-pin';
    div.innerHTML = `
      <label style="flex:1;">${user.name}</label>
      <input type="password" maxlength="4" placeholder="neuer PIN" id="newpin-${user.name}" inputmode="numeric" />
      <button onclick="resetPin('${user.name}')" class="small-btn">PIN setzen</button>
    `;
    container.appendChild(div);
  });
}

function resetPin(name) {
  const input = document.getElementById(`newpin-${name}`);
  const pin = input.value.trim();
  
  if (pin.length !== 4 || !/^\d+$/.test(pin)) {
    alert("Bitte einen 4-stelligen Zahlen-PIN eingeben");
    return;
  }
  
  const user = users.find(u => u.name === name);
  if (user) {
    user.pin = pin;
    saveUsers();
    alert(`PIN für ${name} wurde aktualisiert`);
    input.value = '';
  }
}

function formatDate(d) {
  const [year, month, day] = d.split("-");
  return `${day}.${month}.${year}`;
}

function parseMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

function addEntry() {
  const datum = document.getElementById('datum').value;
  const start = document.getElementById('startzeit').value;
  const end = document.getElementById('endzeit').value;
  const pause = parseInt(document.getElementById('pause').value) || 0;
  const typ = document.getElementById('typ').value;
  
  if (!datum || !start || !end) {
    alert("Bitte füllen Sie alle erforderlichen Felder aus");
    return;
  }
  
  eintraege.push({ user: currentUser, datum, start, end, pause, typ });
  save();
  
  // Formular zurücksetzen (außer Pause und Typ)
  document.getElementById('datum').value = '';
  document.getElementById('startzeit').value = '';
  document.getElementById('endzeit').value = '';
  
  // Nächsten Tag vorauswählen
  const nextDay = new Date(datum);
  nextDay.setDate(nextDay.getDate() + 1);
  document.getElementById('datum').valueAsDate = nextDay;
}

function renderTabelle() {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  const monat = viewDate.toISOString().slice(0,7);
  let summe = 0, urlaub = 0, krank = 0;
  
  eintraege
    .filter(e => e.user === currentUser && e.datum.startsWith(monat))
    .forEach((e, i) => {
      const ist = Math.max(0, parseMinutes(e.end) - parseMinutes(e.start) - e.pause);
      const istH = (ist/60).toFixed(2);
      const diff = e.typ === "Arbeit" ? ist/60 - sollStunden : 0;
      if (e.typ === "Arbeit") summe += diff;
      if (e.typ === "Urlaub") urlaub++;
      if (e.typ === "Krank") krank++;
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDate(e.datum)}</td>
        <td>${e.start}</td>
        <td>${e.end}</td>
        <td>${e.pause}</td>
        <td>${e.typ}</td>
        <td>${e.typ === "Arbeit" ? istH : ""}</td>
        <td>${e.typ === "Arbeit" ? sollStunden : ""}</td>
        <td>${e.typ === "Arbeit" ? diff.toFixed(2) : ""}</td>
        <td><button class="small-btn danger" onclick="deleteEntry(${i})">x</button></td>
      `;
      tbody.appendChild(tr);
    });
  
  document.getElementById("summen").textContent =
    `Überstunden: ${summe.toFixed(2)} | Urlaub: ${urlaub}/${urlaubstage} | Krank: ${krank}`;
  document.getElementById("current-month").textContent = 
    `${viewDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' })}`;
}

function deleteEntry(index) {
  if (confirm("Diesen Eintrag wirklich löschen?")) {
    eintraege.splice(index, 1);
    save();
  }
}

function changeMonth(dir) {
  viewDate.setMonth(viewDate.getMonth() + dir);
  renderTabelle();
}

function exportCSV() {
  const headers = ["Datum","Kommen","Gehen","Pause","Typ","Ist","Soll","+/-"];
  const rows = [headers];
  
  eintraege
    .filter(e => e.user === currentUser)
    .forEach(e => {
      const ist = Math.max(0, parseMinutes(e.end) - parseMinutes(e.start) - e.pause);
      const istH = (ist/60).toFixed(2);
      const diff = e.typ === "Arbeit" ? (ist/60 - sollStunden).toFixed(2) : "";
      
      rows.push([
        formatDate(e.datum), 
        e.start, 
        e.end, 
        e.pause, 
        e.typ,
        e.typ === "Arbeit" ? istH : "",
        e.typ === "Arbeit" ? sollStunden : "",
        diff
      ]);
    });
  
  const csv = rows.map(r => r.join(";")).join("\n");
  const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `zeiterfassung-${currentUser}-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function backupData() {
  const data = {
    users: users,
    eintraege: eintraege,
    timestamp: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `zeiterfassung-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  localStorage.setItem('lastBackup', new Date().toISOString());
  alert("Sicherung wurde erstellt und heruntergeladen");
}

function restoreData(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    if (confirm("Sicher, dass Sie Daten wiederherstellen möchten?\nExistierende Daten werden überschrieben!")) {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.users || !data.eintraege) throw new Error("Ungültiges Backup-Format");
        
        users = data.users;
        eintraege = data.eintraege;
        saveUsers();
        save();
        alert("Daten erfolgreich wiederhergestellt!");
      } catch (error) {
        alert("Fehler beim Wiederherstellen: " + error.message);
      }
    }
  };
  reader.onerror = () => alert("Fehler beim Lesen der Datei");
  reader.readAsText(file);
}
</script>
</body>
</html>
