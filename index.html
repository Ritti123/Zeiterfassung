<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zeiterfassung</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .section {
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    input, select, button {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button.delete {
      background-color: #e74c3c;
    }
    button.secondary {
      background-color: #2ecc71;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f9f9f9;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    .stat-box {
      flex: 1;
      min-width: 200px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
    .month-selector {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="section">
    <h2>Zeiterfassung</h2>

    <div>
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    <div>
      <label for="start-time">Startzeit:</label>
      <input type="time" id="start-time">
    </div>
    <div>
      <label for="end-time">Endzeit:</label>
      <input type="time" id="end-time">
    </div>
    <div>
      <label for="break">Pause (Minuten):</label>
      <input type="number" id="break" value="30">
    </div>
    <div>
      <label for="type">Art:</label>
      <select id="type">
        <option value="Arbeit">Arbeit</option>
        <option value="Urlaub">Urlaub</option>
        <option value="Krank">Krank</option>
        <option value="Feiertag">Feiertag</option>
      </select>
    </div>
    <button id="add-entry-btn">Eintrag hinzufügen</button>

    <div class="month-selector">
      <label for="month">Monat anzeigen:</label>
      <input type="month" id="month">
    </div>

    <h3>Zeiteinträge</h3>
    <table id="time-entries">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Start</th>
          <th>Ende</th>
          <th>Pause</th>
          <th>Art</th>
          <th>Stunden</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="stats">
      <div class="stat-box">
        <h4>Überstunden</h4>
        <p id="overtime">0 Stunden</p>
      </div>
      <div class="stat-box">
        <h4>Urlaubstage</h4>
        <p id="vacation-days">0 Tage</p>
      </div>
      <div class="stat-box">
        <h4>Krankheitstage</h4>
        <p id="sick-days">0 Tage</p>
      </div>
      <div class="stat-box">
        <h4>Feiertage</h4>
        <p id="holiday-days">0 Tage</p>
      </div>
    </div>

    <button id="export-csv-btn" class="secondary">Als CSV exportieren</button>
    <button id="export-backup-btn" class="secondary">Daten sichern</button>
    <button id="import-backup-btn">Daten wiederherstellen</button>
    <input type="file" id="import-file" style="display:none">
  </div>

  <script>
    const WORK_HOURS_PER_DAY = 8;
    const VACATION_DAYS_PER_YEAR = 24;

    let timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');

    const addEntryBtn = document.getElementById('add-entry-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const exportBackupBtn = document.getElementById('export-backup-btn');
    const importBackupBtn = document.getElementById('import-backup-btn');
    const importFile = document.getElementById('import-file');
    const tbody = document.querySelector('#time-entries tbody');
    const monthInput = document.getElementById('month');

    addEntryBtn.addEventListener('click', addTimeEntry);
    exportCsvBtn.addEventListener('click', exportCSV);
    exportBackupBtn.addEventListener('click', exportBackup);
    importBackupBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', handleImport);
    monthInput.addEventListener('change', loadEntries);

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date').valueAsDate = new Date();
      const now = new Date();
      monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      loadEntries();
    });

    function addTimeEntry() {
      const date = document.getElementById('date').value;
      const start = document.getElementById('start-time').value;
      const end = document.getElementById('end-time').value;
      const pause = parseInt(document.getElementById('break').value) || 0;
      const type = document.getElementById('type').value;

      if (!date || (!start && type === 'Arbeit') || (!end && type === 'Arbeit')) {
        alert('Bitte alle Pflichtfelder ausfüllen.');
        return;
      }

      let hours = 0;
      if (type === 'Arbeit') {
        const startDate = new Date(`${date}T${start}`);
        const endDate = new Date(`${date}T${end}`);
        const diff = (endDate - startDate) / 60000 - pause;
        if (diff <= 0) {
          alert('Endzeit muss nach Startzeit liegen.');
          return;
        }
        hours = (diff / 60).toFixed(2);
      }

      timeEntries.push({ date, start, end, pause, type, hours });
      localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
      loadEntries();
      document.getElementById('start-time').value = '';
      document.getElementById('end-time').value = '';
      document.getElementById('date').valueAsDate = new Date(new Date(date).getTime() + 86400000);
    }

    function loadEntries() {
      tbody.innerHTML = '';
      let overtime = 0;
      let vacation = 0;
      let sick = 0;
      let holidays = 0;

      const selectedMonth = monthInput.value;
      const entries = timeEntries.filter(e => e.date.startsWith(selectedMonth)).sort((a, b) => new Date(a.date) - new Date(b.date));

      entries.forEach((entry, index) => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = formatDate(entry.date);
        row.insertCell(1).textContent = entry.start || '-';
        row.insertCell(2).textContent = entry.end || '-';
        row.insertCell(3).textContent = entry.pause || 0;
        row.insertCell(4).textContent = entry.type;
        row.insertCell(5).textContent = entry.hours || '0';

        if (entry.type === 'Arbeit') {
          overtime += parseFloat(entry.hours) - WORK_HOURS_PER_DAY;
        } else if (entry.type === 'Urlaub') {
          vacation++;
        } else if (entry.type === 'Krank') {
          sick++;
        } else if (entry.type === 'Feiertag') {
          holidays++;
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Löschen';
        deleteBtn.className = 'delete';
        deleteBtn.onclick = () => {
          const indexAll = timeEntries.indexOf(entry);
          timeEntries.splice(indexAll, 1);
          localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
          loadEntries();
        };
        row.insertCell(6).appendChild(deleteBtn);
      });

      document.getElementById('overtime').textContent = `${overtime.toFixed(2)} Stunden`;
      document.getElementById('vacation-days').textContent = `${vacation} Tage`;
      document.getElementById('sick-days').textContent = `${sick} Tage`;
      document.getElementById('holiday-days').textContent = `${holidays} Tage`;
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}.${m}.${y}`;
    }

    function exportCSV() {
      if (timeEntries.length === 0) return alert('Keine Daten vorhanden.');

      let csv = 'Datum;Start;Ende;Pause;Art;Stunden\n';
      timeEntries.forEach(e => {
        csv += `${formatDate(e.date)};${e.start || ''};${e.end || ''};${e.pause};${e.type};${e.hours}\n`;
      });
      download('zeiterfassung.csv', csv, 'text/csv');
    }

    function exportBackup() {
      const data = { entries: timeEntries, exported: new Date().toISOString() };
      download('backup_zeiterfassung.json', JSON.stringify(data, null, 2), 'application/json');
    }

    function download(filename, content, type) {
      const blob = new Blob(["\uFEFF" + content], { type });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const data = JSON.parse(event.target.result);
          if (!Array.isArray(data.entries)) throw new Error('Ungültiges Format');
          if (confirm(`${data.entries.length} Einträge importieren? Vorherige Daten werden überschrieben.`)) {
            timeEntries = data.entries;
            localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
            loadEntries();
            alert('Import erfolgreich.');
          }
        } catch (err) {
          alert('Fehler beim Import: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
