<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#3498db">
  <title>Zeiterfassung</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <style>
    :root {
      --bg-color: #f4f6f8;
      --text-color: #333;
      --section-bg: #fff;
      --border-color: #ddd;
      --button-primary: #3498db;
      --button-danger: #e74c3c;
      --button-success: #2ecc71;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --input-border: #ccc;
      --stat-bg: #fff;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #f0f0f0;
      --section-bg: #2d2d2d;
      --border-color: #444;
      --button-primary: #2980b9;
      --button-danger: #c0392b;
      --button-success: #27ae60;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
      --input-border: #555;
      --stat-bg: #3d3d3d;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
      background: var(--bg-color);
      color: var(--text-color);
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }
    h2, h3, h4 { margin-top: 0; }
    .section {
      background: var(--section-bg);
      border: 1px solid var(--border-color);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }
    input, select, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      font-size: 16px;
      background: var(--section-bg);
      color: var(--text-color);
    }
    input::placeholder { color: #aaa; }
    button {
      background-color: var(--button-primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      -webkit-appearance: none;
    }
    button.delete { background-color: var(--button-danger); }
    button.secondary { background-color: var(--button-success); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: var(--section-bg);
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
    }
    th { background-color: var(--stat-bg); }
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    .stat-box {
      flex: 1;
      min-width: 140px;
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 5px;
      background-color: var(--stat-bg);
    }
    .settings { margin-top: 20px; }
    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--button-primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .install-btn {
      position: fixed;
      top: 60px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--button-success);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      display: none;
    }
    @media (max-width: 600px) {
      .stat-box { min-width: 100%; }
      table { font-size: 14px; }
      th, td { padding: 5px; }
    }
    @media (display-mode: standalone) {
      body {
        padding-top: 20px;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="theme-toggle">üåì</button>
  <button class="install-btn" id="install-btn">üì≤</button>
  
  <div class="section">
    <h2>Zeiterfassung</h2>

    <div class="settings">
      <label for="work-hours">T√§gliche Sollstunden:</label>
      <input type="number" id="work-hours" min="1" max="24" value="8">

      <label for="vacation-days-year">Urlaubstage pro Jahr:</label>
      <input type="number" id="vacation-days-year" min="1" max="365" value="24">
    </div>

    <div>
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    <div>
      <label for="start-time">Kommen:</label>
      <input type="time" id="start-time" placeholder="z.‚ÄØB. 08:00" pattern="[0-9]{2}:[0-9]{2}">
    </div>
    <div>
      <label for="end-time">Gehen:</label>
      <input type="time" id="end-time" placeholder="z.‚ÄØB. 16:30" pattern="[0-9]{2}:[0-9]{2}">
    </div>
    <div>
      <label for="break">Pause (Minuten):</label>
      <input type="number" id="break" value="30" placeholder="z.‚ÄØB. 30" min="0" max="240">
    </div>
    <div>
      <label for="type">Art:</label>
      <select id="type">
        <option value="Arbeit">Arbeit</option>
        <option value="Urlaub">Urlaub</option>
        <option value="Krank">Krank</option>
        <option value="Feiertag">Feiertag</option>
      </select>
    </div>
    <button id="add-entry-btn">Eintrag hinzuf√ºgen</button>

    <div id="time-range" style="display: none;">
      <label for="end-date">Bis Datum:</label>
      <input type="date" id="end-date">
      <button id="add-time-range-btn">Zeitraum hinzuf√ºgen</button>
    </div>

    <div>
      <label for="month">Monat anzeigen:</label>
      <input type="month" id="month">
    </div>

    <h3 id="report-title">Monatsreport</h3>
    <div style="overflow-x: auto;">
      <table id="time-entries">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Kommen</th>
            <th>Gehen</th>
            <th>Pause</th>
            <th>Art</th>
            <th>Stunden</th>
            <th>Soll</th>
            <th>Differenz</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="stats">
      <div class="stat-box">
        <h4>√úberstunden</h4>
        <p id="overtime">0:00</p>
      </div>
      <div class="stat-box">
        <h4>Urlaubstage</h4>
        <p id="vacation-days">0 Tage (noch 24 verf√ºgbar)</p>
      </div>
      <div class="stat-box">
        <h4>Krankheitstage</h4>
        <p id="sick-days">0 Tage</p>
      </div>
    </div>

    <button id="export-csv-btn" class="secondary">CSV exportieren</button>
    <button id="export-pdf-btn" class="secondary">PDF exportieren</button>
    <button id="export-backup-btn" class="secondary">Backup speichern</button>
    <button id="import-backup-btn">Backup laden</button>
    <input type="file" id="import-file" style="display:none">
  </div>
  <script>
  // IndexedDB f√ºr bessere Performance
  const DB_NAME = 'TimeTrackingDB';
  const DB_VERSION = 2;
  const STORE_NAME = 'timeEntries';
  let db;
  let timeEntries = [];
  let backupTimestamps = JSON.parse(localStorage.getItem('backupTimestamps') || '[]');
  let deferredPrompt;
  let totalOvertimeMinutes = 0; // Globale Variable f√ºr akkumulierte √úberstunden

  // DOM-Elemente
  const addEntryBtn = document.getElementById('add-entry-btn');
  const exportCsvBtn = document.getElementById('export-csv-btn');
  const exportPdfBtn = document.getElementById('export-pdf-btn');
  const exportBackupBtn = document.getElementById('export-backup-btn');
  const importBackupBtn = document.getElementById('import-backup-btn');
  const importFile = document.getElementById('import-file');
  const tbody = document.querySelector('#time-entries tbody');
  const monthInput = document.getElementById('month');
  const reportTitle = document.getElementById('report-title');
  const themeToggle = document.getElementById('theme-toggle');
  const typeSelect = document.getElementById('type');
  const timeRangeDiv = document.getElementById('time-range');
  const addTimeRangeBtn = document.getElementById('add-time-range-btn');
  const workHoursInput = document.getElementById('work-hours');
  const vacationDaysInput = document.getElementById('vacation-days-year');
  const installBtn = document.getElementById('install-btn');

  // Initialisierung
  document.addEventListener('DOMContentLoaded', async () => {
    await initDB();
    const now = new Date();
    document.getElementById('date').valueAsDate = now;
    monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    workHoursInput.value = localStorage.getItem('workHours') || 8;
    vacationDaysInput.value = localStorage.getItem('vacationDays') || 24;
    loadEntries();
    checkBackupReminder();
    
    // Theme aus localStorage laden
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Install Button anzeigen, wenn PWA installierbar
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'flex';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        installBtn.style.display = 'none';
      }
      deferredPrompt = null;
    });

    // Service Worker registrieren
    if ('serviceWorker' in navigator) {
      try {
        await navigator.serviceWorker.register('sw.js');
        console.log('Service Worker registriert');
      } catch (error) {
        console.error('Service Worker Registrierung fehlgeschlagen:', error);
      }
    }
  });

  // Hilfsfunktion zum Berechnen des Urlaubszeitraums
  function getVacationByYear() {
    const vacationDaysByYear = {};
    const totalVacationDays = parseInt(localStorage.getItem('vacationDays') || 24;
    
    timeEntries.forEach(entry => {
      if (entry.type === 'Urlaub') {
        const year = new Date(entry.date).getFullYear();
        if (!vacationDaysByYear[year]) {
          vacationDaysByYear[year] = {
            total: totalVacationDays,
            used: 0,
            remaining: totalVacationDays
          };
        }
        vacationDaysByYear[year].used++;
        vacationDaysByYear[year].remaining--;
      }
    });
    
    return vacationDaysByYear;
  }

  // Aktualisierte Statistikfunktion
  function updateStats(overtimeMinutes, vacation, totalVacationDays, sick) {
    const oh = Math.floor(Math.abs(overtimeMinutes) / 60);
    const om = Math.abs(overtimeMinutes) % 60;
    const sign = overtimeMinutes < 0 ? "-" : "";
    document.getElementById('overtime').textContent = `${sign}${oh}:${String(om).padStart(2, '0')}`;
    
    // Urlaubsberechnung nach Jahr
    const vacationData = getVacationByYear();
    const currentYear = new Date().getFullYear();
    const prevYear = currentYear - 1;
    
    let vacationText = '';
    if (vacationData[prevYear] && vacationData[prevYear].remaining > 0) {
      vacationText = `${vacationData[currentYear]?.used || 0} Tage (${vacationData[prevYear].remaining} aus ${prevYear} √ºbertragen)`;
    } else {
      vacationText = `${vacationData[currentYear]?.used || 0} Tage (noch ${vacationData[currentYear]?.remaining || totalVacationDays} von ${totalVacationDays} verf√ºgbar)`;
    }
    
    document.getElementById('vacation-days').textContent = vacationText;
    document.getElementById('sick-days').textContent = `${sick} Tage`;
  }

  // Event Listener f√ºr Einstellungen
  workHoursInput.addEventListener('change', function() {
    localStorage.setItem('workHours', this.value);
    loadEntries();
  });

  vacationDaysInput.addEventListener('change', function() {
    localStorage.setItem('vacationDays', this.value);
    loadEntries();
  });

  // Event Listener
  addEntryBtn.addEventListener('click', addTimeEntry);
  exportCsvBtn.addEventListener('click', exportCSV);
  exportPdfBtn.addEventListener('click', exportPDF);
  exportBackupBtn.addEventListener('click', exportBackup);
  importBackupBtn.addEventListener('click', () => importFile.click());
  importFile.addEventListener('change', handleImport);
  monthInput.addEventListener('change', loadEntries);
  themeToggle.addEventListener('click', toggleTheme);
  typeSelect.addEventListener('change', (e) => {
    const showRange = ['Urlaub', 'Krank', 'Feiertag'].includes(e.target.value);
    timeRangeDiv.style.display = showRange ? 'block' : 'none';
  });
  addTimeRangeBtn.addEventListener('click', addTimeRange);

  // IndexedDB Initialisierung
  function initDB() {
    return new Promise((resolve, reject) {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      
      request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        }
      };
      
      request.onsuccess = (event) => {
        db = event.target.result;
        resolve();
      };
      
      request.onerror = (event) => {
        console.error('IndexedDB error:', event.target.error);
        timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');
        resolve();
      };
    });
  }

  // Daten in IndexedDB speichern
  function saveEntry(entry) {
    return new Promise((resolve, reject) {
      if (!db) {
        timeEntries.push(entry);
        localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
        resolve();
        return;
      }
      
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      const request = store.add(entry);
      
      request.onsuccess = () => resolve();
      request.onerror = (event) => {
        console.error('Error saving entry:', event.target.error);
        reject(event.target.error);
      };
    });
  }

  // Daten aus IndexedDB laden
  function loadEntries() {
    const selectedMonth = monthInput.value;
    const [year, month] = selectedMonth.split("-");
    const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 
                       'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    reportTitle.textContent = `Monatsreport ${monthNames[parseInt(month)-1]} ${year}`;

    if (!db) {
      timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');
      timeEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
      renderEntries();
      return;
    }

    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();

    request.onsuccess = (event) => {
      timeEntries = event.target.result || [];
      timeEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // √úberstunden neu berechnen bei jedem Laden
      totalOvertimeMinutes = 0;
      timeEntries.forEach(entry => {
        if (entry.type === 'Arbeit') {
          const [h, m] = (entry.hours || '0:00').split(":").map(Number);
          const istMin = h * 60 + m;
          const sollMin = entry.sollHours ? entry.sollHours * 60 : parseFloat(localStorage.getItem('workHours') || 8) * 60;
          totalOvertimeMinutes += istMin - sollMin;
        }
      });
      
      renderEntries();
    };

    request.onerror = (event) => {
      console.error('Error loading entries:', event.target.error);
      timeEntries = JSON.parse(localStorage.getItem('timeEntries') || '[]');
      timeEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
      renderEntries();
    };
  }

  // Eintr√§ge rendern
  function renderEntries() {
    tbody.innerHTML = '';
    let monthlyOvertimeMinutes = 0;
    let vacation = 0;
    let sick = 0;
    let holiday = 0;

    const selectedMonth = monthInput.value;
    const entries = timeEntries
      .filter(e => e.date && e.date.startsWith(selectedMonth))
      .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const totalVacationDays = parseInt(localStorage.getItem('vacationDays') || 24);

    entries.forEach(entry => {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = formatDate(entry.date);
      row.insertCell(1).textContent = entry.type === 'Arbeit' ? entry.start || '-' : '-';
      row.insertCell(2).textContent = entry.type === 'Arbeit' ? entry.end || '-' : '-';
      row.insertCell(3).textContent = entry.type === 'Arbeit' ? entry.pause || 0 : '-';
      row.insertCell(4).textContent = entry.type;
      row.insertCell(5).textContent = entry.hours || '0:00';

      let istMin = 0;
      if (entry.type === 'Arbeit') {
        const [h, m] = (entry.hours || '0:00').split(":").map(Number);
        istMin = h * 60 + m;
        const sollMin = entry.sollHours ? entry.sollHours * 60 : parseFloat(localStorage.getItem('workHours') || 8) * 60;
        monthlyOvertimeMinutes += istMin - sollMin;
      } else if (entry.type === 'Urlaub') vacation++;
      else if (entry.type === 'Krank') sick++;
      else if (entry.type === 'Feiertag') holiday++;

      const sollHours = entry.sollHours ? entry.sollHours : parseFloat(localStorage.getItem('workHours') || 8);
      row.insertCell(6).textContent = entry.type === 'Arbeit' 
        ? `${Math.floor(sollHours)}:${String(Math.round((sollHours % 1) * 60)).padStart(2, '0')}`
        : '-';

      let diff = istMin - (sollHours * 60);
      row.insertCell(7).textContent = entry.type === 'Arbeit'
        ? `${diff < 0 ? '-' : ''}${Math.floor(Math.abs(diff) / 60)}:${String(Math.abs(diff) % 60).padStart(2, '0')}`
        : '-';

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'L√∂schen';
      deleteBtn.className = 'delete';
      deleteBtn.onclick = () => deleteEntry(entry.id);
      row.insertCell(8).appendChild(deleteBtn);
    });

    // Statistik mit den globalen √úberstunden aktualisieren
    updateStats(totalOvertimeMinutes, vacation, totalVacationDays, sick);
  }

  // [Rest der Funktionen (deleteEntry, addTimeEntry, addTimeRange, resetForm, toggleTheme, exportCSV, exportPDF, exportBackup, handleImport, formatDate, isValidTime, download, checkBackupReminder) bleiben unver√§ndert]
  // ... (Hier w√ºrden die unver√§nderten Funktionen folgen) ...

</script>

<!-- JS-Bibliotheken -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
  // Initialisierung f√ºr jsPDF
  window.jspdf = window.jspdf || {};
</script>
</body>
</html>
